@page "/"
@using AwsCronValidator

<PageTitle>AWS Schedule Validator</PageTitle>

<h1>AWS EventBridge Schedule Expression Validator</h1>

<p>Validate AWS EventBridge Scheduler expressions (CRON, rate, or at).</p>

<div class="mb-3">
    <label for="expressionInput" class="form-label">Schedule Expression</label>
    <input type="text" class="form-control" id="expressionInput" @bind="scheduleExpression" placeholder="e.g., cron(0 10 * * ? *), rate(5 minutes), at(2023-01-01T12:00:00)" />
    <div class="form-text">Supports cron(), rate(), at() prefixes, or CRON without prefix.</div>
</div>

<div class="mb-3">
    <label for="minIntervalInput" class="form-label">Minimum Interval (hours, optional)</label>
    <input type="number" class="form-control" id="minIntervalInput" @bind="minIntervalHours" min="0" step="0.01" />
    <div class="form-text">For CRON: checks min time between executions. For rate: checks if rate interval >= this.</div>
</div>

<div class="mb-3">
    <label for="maxIntervalInput" class="form-label">Maximum Interval (hours, optional)</label>
    <input type="number" class="form-control" id="maxIntervalInput" @bind="maxIntervalHours" min="0" step="0.01" />
    <div class="form-text">For CRON: checks max time between executions. For rate: checks if rate interval <= this.</div>
</div>

<button class="btn btn-primary" @onclick="ValidateExpression">Validate</button>

@if (!string.IsNullOrEmpty(result))
{
    <div class="mt-3 alert @alertClass">
        @result
    </div>
}

@code {
    private string scheduleExpression = "";
    private double? minIntervalHours = null;
    private double? maxIntervalHours = null;
    private string result = "";
    private string alertClass = "";

    private void ValidateExpression()
    {
        if (string.IsNullOrWhiteSpace(scheduleExpression))
        {
            result = "Please enter a schedule expression.";
            alertClass = "alert-danger";
            return;
        }

        try
        {
            var minInterval = minIntervalHours.HasValue && minIntervalHours.Value > 0 ? TimeSpan.FromHours(minIntervalHours.Value) : (TimeSpan?)null;
            var maxInterval = maxIntervalHours.HasValue && maxIntervalHours.Value > 0 ? TimeSpan.FromHours(maxIntervalHours.Value) : (TimeSpan?)null;

            bool isValid = AwsCronValidator.ValidateWithIntervals(scheduleExpression, minInterval, maxInterval);

            if (isValid)
            {
                result = "Valid schedule expression.";
                if (minInterval.HasValue || maxInterval.HasValue)
                {
                    var constraints = new List<string>();
                    if (minInterval.HasValue) constraints.Add($"min {minIntervalHours}h");
                    if (maxInterval.HasValue) constraints.Add($"max {maxIntervalHours}h");
                    result += $" Respects interval constraints ({string.Join(", ", constraints)}).";
                }
            }
            else
            {
                result = "Invalid schedule expression";
                if (minInterval.HasValue || maxInterval.HasValue)
                {
                    var constraints = new List<string>();
                    if (minInterval.HasValue) constraints.Add($"min {minIntervalHours}h");
                    if (maxInterval.HasValue) constraints.Add($"max {maxIntervalHours}h");
                    result += $" or violates interval constraints ({string.Join(", ", constraints)}).";
                }
                else
                {
                    result += ".";
                }
            }

            alertClass = isValid ? "alert-success" : "alert-danger";
        }
        catch (Exception ex)
        {
            result = $"Error: {ex.Message}";
            alertClass = "alert-danger";
        }
    }
}
