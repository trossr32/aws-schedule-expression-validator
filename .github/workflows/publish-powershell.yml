name: Publish PowerShell Module
on:
  push:
    tags: ['*']
    paths:
      - '.github/workflows/publish-powershell.yml'
      - 'src/AwsScheduleExpressionValidator.PsModule/**'

  workflow_call:

  workflow_dispatch:
    inputs:
      tag:
        description: Existing tag to run against (e.g. v1.2.0). Leave empty to use selected ref.
        required: false
        type: string

jobs:
  publish-powershell-gallery:
    permissions:
      contents: read

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag != '' && format('refs/tags/{0}', github.event.inputs.tag) || github.ref }}
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 8.0.x

      - name: dotnet build
        run: dotnet build -c Release
        working-directory: src/AwsScheduleExpressionValidator.PsModule

      - name: Copy help XML
        run: cp AwsScheduleExpressionValidator.PsModule.dll-Help.xml bin/Release/net8.0/
        working-directory: src/AwsScheduleExpressionValidator.PsModule

      - name: Initialize PSResourceGet repository store
        shell: pwsh
        run: |
          $repoStorePath = Join-Path $HOME ".local/share/PSResourceGet/PSResourceRepository.xml"
          $repoStoreDirectory = Split-Path $repoStorePath -Parent

          New-Item -ItemType Directory -Path $repoStoreDirectory -Force | Out-Null

          if (-not (Test-Path $repoStorePath)) {
            @() | Export-Clixml -Path $repoStorePath
          }

          $galleryRepository = Get-PSResourceRepository -Name PSGallery -ErrorAction SilentlyContinue
          if (-not $galleryRepository) {
            Register-PSResourceRepository -PSGallery
          }

          $galleryRepository = Get-PSResourceRepository -Name PSGallery -ErrorAction SilentlyContinue
          if ($galleryRepository -and -not $galleryRepository.Trusted) {
            Set-PSResourceRepository -Name PSGallery -Trusted
          }

      - name: Publish PowerShell Module
        if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.tag != '')
        uses: natescherer/publish-powershell-action@v1
        with:
          token: ${{ secrets.GALLERY_API_KEY }}
          target: gallery
          path: src/AwsScheduleExpressionValidator.PsModule/bin/Release/net8.0
